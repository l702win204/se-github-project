name: CI/CD Pipeline

# è§¦å‘æœºåˆ¶:ä»£ç Pushåˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨è¿è¡Œ
on:
  push:
    branches: [ main ]

jobs:
  # === ä»»åŠ¡1:æ„å»ºå¹¶æ¨é€é•œåƒ ===
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v4

      - name: ğŸ³ ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ”¨ æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest

  # === ä»»åŠ¡2:éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ ===
  deploy:
    needs: build-and-push  # ä»…å½“ä»»åŠ¡1æˆåŠŸåæ‰§è¡Œ
    runs-on: ubuntu-latest
    steps:
      - name: SSHè¿œç¨‹éƒ¨ç½²ï¼ˆå¯†ç è®¤è¯ï¼‰
        uses: appleboy/ssh-action@v1.0.3
        with:
         host: ${{ secrets.SSH_HOST }}       # å¼•ç”¨æœåŠ¡å™¨IPï¼ˆå·²é…ç½®çš„Secretï¼‰
         username: ${{ secrets.SSH_USERNAME }} # å¼•ç”¨ç™»å½•ç”¨æˆ·åï¼ˆå¦‚rootï¼Œå·²é…ç½®çš„Secretï¼‰
         password: ${{ secrets.SSH_PASSWORD }} # å…³é”®ï¼šæ›¿æ¢ä¸ºå¯†ç è®¤è¯ï¼ˆå¼•ç”¨SSH_PASSWORD Secretï¼‰
         script: |
           # åœæ­¢æ—§å®¹å™¨
           docker stop my-app || true
           # åˆ é™¤æ—§å®¹å™¨
           docker rm my-app || true
           # æ‹‰å–æœ€æ–°é•œåƒ
           docker pull ***/project-alpha:latest
           # å¯åŠ¨æ–°å®¹å™¨
           docker run -d \
             --name my-app \
             --restart always \
             -p 8080:8080 \
             ***/project-alpha:latest
