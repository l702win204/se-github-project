name: CI/CD Pipeline

# è§¦å‘å™¨: å½“ä»£ç Pushåˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è¿è¡Œ
on:
  push:
    branches: [ main ]

jobs:
  # === ä»»åŠ¡1:æ„å»ºå¹¶æ¨é€é•œåƒ ===
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v4

      - name: ğŸ³ ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸš€ æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # ä¿®å¤ï¼štagsä½¿ç”¨æ•°ç»„æ ¼å¼ï¼ŒåŒæ—¶æ·»åŠ æäº¤å“ˆå¸Œæ ‡ç­¾ï¼ˆé¿å…latestè¦†ç›–é£é™©ï¼‰
          tags:
            - ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest
            - ${{ secrets.DOCKER_USERNAME }}/project-alpha:${{ github.sha }}

  # === ä»»åŠ¡2:éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ ===
  deploy:
    needs: build-and-push # åªæœ‰ä»»åŠ¡1æˆåŠŸäº†æ‰æ‰§è¡Œéƒ¨ç½²
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ SSH è¿œç¨‹éƒ¨ç½²
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true # å¦‚æœè„šæœ¬å‡ºé”™ç«‹å³åœæ­¢
          # è¿œç¨‹æ‰§è¡Œçš„Shellè„šæœ¬
          script: |
            echo "--- å¼€å§‹éƒ¨ç½²æµç¨‹ ---"

            # 1. åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨ (å¦‚æœå­˜åœ¨)
            docker stop my-app || true
            docker rm my-app || true

            # 2. æ‹‰å– Docker Hub ä¸Šçš„æœ€æ–°é•œåƒï¼ˆä½¿ç”¨æäº¤å“ˆå¸Œæ ‡ç­¾ï¼Œä¸æ„å»ºç‰ˆæœ¬ä¸€è‡´ï¼‰
            echo "æ­£åœ¨æ‹‰å–æœ€æ–°é•œåƒ..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/project-alpha:${{ github.sha }}

            # 3. å¯åŠ¨æ–°å®¹å™¨ï¼ˆä¿®å¤ï¼šæ¢è¡Œç¬¦\åæ— å¤šä½™ç©ºæ ¼ï¼‰
            echo "å¯åŠ¨æ–°å®¹å™¨..."
            docker run -d \
            --name my-app \
            --restart always \
            -p 8080:8080 \
            ${{ secrets.DOCKER_USERNAME }}/project-alpha:${{ github.sha }}

            echo "--- éƒ¨ç½²å®Œæˆ ---"
