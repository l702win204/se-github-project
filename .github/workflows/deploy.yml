name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ§ª è°ƒè¯•DOCKER_USERNAMEå˜é‡
        run: echo "å½“å‰DOCKER_USERNAME:${{ secrets.DOCKER_USERNAME }}"

      - name: ğŸ³ ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ”¨ æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ–¥ï¸ SSH è¿œç¨‹éƒ¨ç½²
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            # 1. å…ˆç™»å½•Docker Hubï¼ˆé¿å…æœåŠ¡å™¨æœªç¼“å­˜å‡­è¯ï¼‰
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            
            # 2. åœæ­¢åˆ é™¤æ—§å®¹å™¨ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
            docker stop my-app || true
            docker rm my-app || true

            # 3. æ‹‰å–é•œåƒï¼ˆåŠ é‡è¯•+å¼ºåˆ¶æ›´æ–°ï¼Œè§£å†³è¶…æ—¶/ç‰ˆæœ¬é—®é¢˜ï¼‰
            IMAGE=${{ secrets.DOCKER_USERNAME }}/project-alpha:latest
            echo "å¼€å§‹æ‹‰å–é•œåƒ: $IMAGE"
            # é‡è¯•3æ¬¡ï¼Œæ¯æ¬¡é—´éš”5ç§’ï¼Œ--pull alwayså¼ºåˆ¶æ‹‰æœ€æ–°
            for i in {1..3}; do
              if docker pull --pull always $IMAGE; then
                echo "é•œåƒæ‹‰å–æˆåŠŸ"
                break
              else
                echo "ç¬¬$iæ¬¡æ‹‰å–å¤±è´¥ï¼Œ5ç§’åé‡è¯•..."
                sleep 5
              fi
            done

            # 4. å¯åŠ¨æ–°å®¹å™¨ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
            docker run -d \
              --name my-app \
              --restart always \
              -p 8080:8080 \
              $IMAGE
