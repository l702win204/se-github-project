name: CI/CD Pipeline

# è§¦å‘æœºåˆ¶:ä»£ç Pushåˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨è¿è¡Œ
on:
  push:
    branches: [ main ]

jobs:
  # === ä»»åŠ¡1:æ„å»ºå¹¶æ¨é€é•œåƒï¼ˆæ–°å¢å˜é‡è°ƒè¯•ï¼‰ ===
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v4

      - name: ğŸ§ª è°ƒè¯•DOCKER_USERNAMEå˜é‡
        run: echo "å½“å‰DOCKER_USERNAME:${{ secrets.DOCKER_USERNAME }}"
        # è§‚å¯Ÿæ—¥å¿—ï¼šè‹¥æ˜¾ç¤ºæ­£ç¡®ç”¨æˆ·ååˆ™å¯†é’¥æ­£å¸¸ï¼›è‹¥ä¸º***åˆ™éœ€é‡æ–°é…ç½®

      - name: ğŸ³ ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ”¨ æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest

  # === ä»»åŠ¡2:éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ï¼ˆç¡®ä¿å˜é‡æ ¼å¼æ­£ç¡®ï¼‰ ===
  deploy:
    needs: build-and-push  # ä»…å½“ä»»åŠ¡1æˆåŠŸåæ‰§è¡Œ
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ–¥ï¸ SSH è¿œç¨‹éƒ¨ç½²
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          
          script: |
            # åœæ­¢æ—§å®¹å™¨
            docker stop my-app || true
            docker rm my-app || true

            # æ‹‰å–é•œåƒï¼ˆå¼ºåˆ¶å˜é‡æ ¼å¼ï¼šåŒå¤§æ‹¬å·+ç©ºæ ¼ï¼‰
            echo "æ‹‰å–é•œåƒ: ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest"
            docker pull ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest

            # å¯åŠ¨æ–°å®¹å™¨
            docker run -d \
              --name my-app \
              --restart always \
              -p 8080:8080 \
              ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest
