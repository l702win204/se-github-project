name: CI/CD Pipeline

# è§¦å‘æœºåˆ¶: å½“ä»£ç Pushåˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨è¿è¡Œ
on:
  push:
    branches: [ main ]

jobs:
  # == ä»»åŠ¡1: æ„å»ºå¹¶æ¨é€é•œåƒ ==
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç (Checkout)
        uses: actions/checkout@v4

      - name: ğŸ³ ç™»å½•Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ› ï¸ æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          dockerfile: ./Dockerfile  # æ˜¾å¼æŒ‡å®šDockerfileè·¯å¾„ï¼ˆå…³é”®ä¿®æ­£ï¼‰
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest

  # == ä»»åŠ¡2: éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ ==
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ SSHè¿œç¨‹éƒ¨ç½²
        uses: appleboy/ssh-action@v1.2.0  # å‡çº§åˆ°æœ€æ–°ç¨³å®šç‰ˆï¼ˆå…³é”®ä¿®æ­£ï¼‰
        with:
          host: ${{ secrets.HOST_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            echo "--- å¼€å§‹éƒ¨ç½²æµç¨‹ ---"

            # 1. åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            sudo docker stop my-app || true  # å¢åŠ sudoï¼ˆå…³é”®ä¿®æ­£ï¼‰
            sudo docker rm my-app || true

            # 2. æ‹‰å–æœ€æ–°é•œåƒï¼ˆå¤±è´¥åˆ™ç»ˆæ­¢è„šæœ¬ï¼‰
            echo "æ­£åœ¨æ‹‰å–æœ€æ–°é•œåƒ..."
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest || exit 1  # å¤„ç†æ‹‰å–å¤±è´¥ï¼ˆå…³é”®ä¿®æ­£ï¼‰

            # 3. å¯åŠ¨æ–°å®¹å™¨
            echo "å¯åŠ¨æ–°å®¹å™¨..."
            sudo docker run -d \
              --name my-app \
              --restart always \
              -p 8080:8080 \
              ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest

            echo "--- éƒ¨ç½²å®Œæˆ ---"
